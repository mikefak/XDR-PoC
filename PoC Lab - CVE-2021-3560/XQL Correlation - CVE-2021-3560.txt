//XQL Query for CVE-2021-3560

//Multiple dbus send commands via SSH (>=3)

dataset = xdr_data

| filter event_type = ENUM.PROCESS

| filter action_process_image_name ~= "dbus-send"

| filter agent_os_type = AGENT_OS_LINUX

| filter causality_actor_process_image_name = "sshd"

| fields agent_hostname as Linux_Hostname, actor_process_command_line as Command_Executed, actor_process_os_pid as PID, actor_effective_username as Actor_Username, action_process_image_command_line as DBUS_Command, causality_actor_process_image_name, action_process_image_name as DBUS_Action, action_file_path

| comp count(Command_Executed) as Potential_Cred_Insertions by Linux_Hostname, PID, Actor_Username, DBUS_Command, DBUS_Action

| filter Potential_Cred_Insertions  >= 3

| sort desc Potential_Cred_Insertions